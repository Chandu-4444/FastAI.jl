<HTML><head><title>Data containers</title><link href=../template/hugobook.css rel=stylesheet ></link><meta content=Type=text/html; charset=utf-8 http-equiv=Content-Type ></meta></head><body><input onclick=toggleMenu() id=menu-control class=hidden toggle type=checkbox ></input><input id=toc-control type=checkbox class=hidden toggle ></input><main class=container flex ><aside id=menu-container class=book-menu ><nav class=book-menu-content ><h2 id=title >FastAI.jl</h2><div id=sidebar ><div class=doctree ><body><ul><li><p><a href=../README.md.html title= >README</a></p></li><li><p><a href=setup.md.html title= >Setup</a></p></li><li><p><a href=quickstart.md.html title= >Quickstart</a></p></li><li><p>Tutorials</p><ul><li><p><a href=introduction.md.html title= >Introduction</a></p></li><li><p><a href=data_containers.md.html title= >Data containers</a></p></li><li><p><a href=learning_methods.md.html title= >Learning methods</a></p></li></ul></li><li><p>Learning tasks</p><ul><li><p><a href=methods/imageclassification.md.html title= >Image classification</a></p></li><li><p><a href=methods/imagesegmentation.md.html title= >Image segmentation</a></p></li></ul></li><li><p>How To</p><ul><li><p><a href=notebooks/fitonecycle.ipynb.html title= >Train a model from scratch</a></p></li><li><p><a href=notebooks/finetune.ipynb.html title= >Finetune a pretrained model</a></p></li><li><p><a href=notebooks/lrfind.ipynb.html title= >Find a good learning rate</a></p></li></ul></li><li><p>Reference</p><ul><li><p><a href=../REFERENCE.html title= >Docstrings</a></p></li><li><p><a href=interfaces.md.html title= >Interfaces</a></p></li><li><p><a href=api.md.html title= >API</a></p></li><li><p><a href=glossary.md.html title= >Glossary</a></p></li></ul></li><li><p>Background</p><ul><li><p><a href=background/datapipelines.md.html title= >Performant data pipelines</a></p></li></ul></li></ul></body></div></div></nav></aside><div class=book-page ><header class=book-header ></header><article><h1 id=data-containers >Data containers</h1><p><em>This tutorial explains what data containers are, how they are used in FastAI.jl and how to create your own. You are encouraged to follow along in a REPL or a Jupyter notebook and explore the code. You will find small exercises at the end of some sections to deepen your understanding.</em></p><h2 id=introduction >Introduction</h2><p>In the <a href=./quickstart.md.html title= >quickstart</a> section, you have already come in contact with data containers. The following code was used to load a data container for image classification:</p><div class=cellcontainer ><pre result=false output=false cell=main lang=julia style=display:none; ><code>ENV[&quot;DATADEPS_ALWAYS_ACCEPT&quot;] = &quot;true&quot;
</code></pre></div><div class=cellcontainer ><pre cell=main lang=julia ><code>using FastAI
using FastAI.Datasets
using FastAI.Datasets: datasetpath, loadtaskdata

NAME = &quot;imagenette2-160&quot;
dir = datasetpath(NAME)
data = loadtaskdata(dir, ImageClassificationTask)
</code></pre><pre class=codeoutput ><code>
7-Zip (a) [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21
p7zip Version 16.02 (locale=C.UTF-8,Utf16=on,HugeFiles=on,64 bits,2 CPUs Intel(R) Xeon(R) CPU E5-2673 v4 @ 2.30GHz (406F1),ASM,AES-NI)


Extracting archive: 
--
Path = 
Type = tar
Code Page = UTF-8

Everything is Ok

Folders: 23
Files: 13397
Size:       107794109
Compressed: 6872064
</code></pre><pre class=coderesult ><code>LoadError("string", 7, MethodError(parent, ("/home/runner/.julia/datadeps/fastai-imagenette2-160/imagenette2-160/train/n01440764/ILSVRC2012_val_00000293.JPEG",), 0x0000000000007636))</code></pre></div><p>A data container is any type that holds observations of data and allows us to load them with <code>getobs</code> and query the number of observations with <code>nobs</code>:</p><div class=cellcontainer ><pre cell=main lang=julia ><code>obs = getobs(data, 1)
</code></pre><pre class=coderesult ><code>LoadError("string", 1, UndefVarError(:data))</code></pre></div><div class=cellcontainer ><pre cell=main lang=julia ><code>nobs(data)
</code></pre><pre class=coderesult ><code>LoadError("string", 1, UndefVarError(:data))</code></pre></div><p>In this case, each observation is a tuple of an image and the corresponding class; after all, we want to use it for image classification.</p><div class=cellcontainer ><pre cell=main lang=julia ><code>image, class = obs
@show class
image
</code></pre><pre class=coderesult ><code>LoadError("string", 1, UndefVarError(:obs))</code></pre></div><p>As you saw above, the <code>Datasets</code> submodule provides functions for loading and creating data containers. We used <a href=../REFERENCE/FastAI.Datasets.Datasets.datasetpath.html ><code>datasetpath</code></a> to download a dataset if it wasn’t yet and get the folder it was downloaded to. Then, <a href=../REFERENCE/FastAI.Datasets.Datasets.loadtaskdata.html ><code>loadtaskdata</code></a> took the folder and loaded a data container suitable for image classification. FastAI.jl makes it easy to download the datasets from fastai’s collection on AWS Open Datasets. For the full list, see <a href=../REFERENCE/FastAI.Datasets.Datasets.DATASETS.html ><code>DATASETS</code></a></p><h3 id=exercises >Exercises</h3><ul><li><p>Have a look at the other image classification datasets in <a href=../REFERENCE/FastAI.Datasets.Datasets.DATASETS_IMAGECLASSIFICATION.html ><code>FastAI.Datasets.DATASETS_IMAGECLASSIFICATION</code></a> and change the above code to load a different dataset.</p></li></ul><h2 id=creating-data-containers-from-files >Creating data containers from files</h2><p><code>loadtaskdata</code> makes it easy to get started when your dataset already comes in the correct format, but alas, datasets come in all different shapes and sizes. Let’s create the same data container, but now using more general functions FastAI.jl provides to get a look behind the scenes. If each observation in your dataset is a file in a folder, <a href=../REFERENCE/FastAI.Datasets.Datasets.FileDataset.html ><code>FileDataset</code></a> conveniently creates a data container given a path. We’ll use the path of the downloaded dataset:</p><div class=cellcontainer ><pre cell=main lang=julia ><code>using FastAI.Datasets: FileDataset

filedata = FileDataset(dir)
</code></pre><pre class=coderesult ><code>FileDataset("/home/runner/.julia/datadeps/fastai-imagenette2-160/imagenette2-160", 13397 observations)</code></pre></div><p><code>filedata</code> is a data container where each observation is a path to a file. We’ll confirm that using <code>getobs</code>:</p><div class=cellcontainer ><pre cell=main lang=julia ><code>p = getobs(filedata, 100)
</code></pre><pre class=coderesult ><code>/home/runner/.julia/datadeps/fastai-imagenette2-160/imagenette2-160/train/n01440764/n01440764_10847.JPEG</code></pre></div><p>Next we need to load an image and the corresponding class from the path. If you have a look at the folder structure of <code>dir</code> you can see that the parent folder of each file gives the name of class. So we can use the following function to load the <code>(image, class)</code> pair from a path:</p><div class=cellcontainer ><pre cell=main lang=julia ><code>using FastAI.Datasets: loadfile, filename

function loadimageclass(p)
    return (
        Datasets.loadfile(p),
        filename(parent(p)),
    )
end

image, class = loadimageclass(p)
@show class
image
</code></pre><pre class=coderesult ><code>LoadError("string", 10, MethodError(parent, ("/home/runner/.julia/datadeps/fastai-imagenette2-160/imagenette2-160/train/n01440764/n01440764_10847.JPEG",), 0x0000000000007637))</code></pre></div><p>Finally, we use <a href=../REFERENCE/FastAI.Datasets.Datasets.mapobs.html ><code>mapobs</code></a> to lazily transform each observation and have a data container ready to be used for training an image classifier.</p><div class=cellcontainer ><pre cell=main lang=julia ><code>data = mapobs(loadimageclass, filedata);
</code></pre><pre class=coderesult ><code>mapobs(loadimageclass, FileDataset("/home/runner/.julia/datadeps/fastai-imagenette2-160/imagenette2-160", 13397 observations))</code></pre></div><h3 id=exercises >Exercises</h3><ul><li><p>Using <code>mapobs</code> and <code>loadfile</code>, create a data container where every observation is only an image.</p></li></ul><h2 id=splitting-a-data-container-into-subsets >Splitting a data container into subsets</h2><p>Until now, we’ve only created a single data container containing all observations in a dataset. In practice, though, you’ll want to have at least a training and validation split. The easiest way to get these is to randomly split your data container into two parts. Here we split <code>data</code> into 80% training and 20% validation data. Note the use of <code>shuffleobs</code> to make sure each split has approximately the same class distribution.</p><div class=cellcontainer ><pre cell=main lang=julia ><code>traindata, valdata = splitobs(shuffleobs(data), at = 0.8);
</code></pre><pre class=coderesult ><code>(DataSubset(::FastAI.Datasets.MappedData, view(::Vector{Int64}, 1:10718), ObsDim.Undefined())
 10718 observations, DataSubset(::FastAI.Datasets.MappedData, view(::Vector{Int64}, 10719:13397), ObsDim.Undefined())
 2679 observations)</code></pre></div><p>This is great for experimenting, but where possible you will want to use the official training/validation split for a dataset. Consider the image classification dataset folder structure:</p><pre lang= ><code>- $dir
    - train
        - class1
            - image1.jpg
            - image2.jpg
            - ...
        - class2
        - ...
    - valid
        - class1
        - class2
        - ...
</code></pre><p>As you can see, the grandparent folder of each image indicates which split it is a part of. <a href=../REFERENCE/FastAI.Datasets.Datasets.groupobs.html ><code>groupobs</code></a> allows us to partition a data container using a function. Let’s use it to split <code>filedata</code> based on the name of the grandparent directory. (We can’t reuse <code>data</code> for this since it no longer carries the file information.)</p><div class=cellcontainer ><pre cell=main lang=julia ><code>trainfiledata, validfiledata = groupobs(filedata) do p
    filename(parent(parent(p)))
end
nobs(trainfiledata), nobs(validfiledata)
</code></pre><pre class=coderesult ><code>LoadError("string", 1, MethodError(parent, ("/home/runner/.julia/datadeps/fastai-imagenette2-160/imagenette2-160/.DS_Store",), 0x000000000000763d))</code></pre></div><p>Using this official split, it will be easier to compare the performance of your results with those of others’.</p></article><footer class=book-footer ></footer></div><aside class=book-toc ><nav id=toc class=book-toc-content ><ul><li><a href=#data-containers >Data containers</a><ul><li><a href=#introduction >Introduction</a><ul><li><a href=#exercises >Exercises</a><ul></ul></li></ul></li><li><a href=#creating-data-containers-from-files >Creating data containers from files</a><ul><li><a href=#exercises >Exercises</a><ul></ul></li></ul></li><li><a href=#splitting-a-data-container-into-subsets >Splitting a data container into subsets</a><ul></ul></li></ul></li></ul></nav></aside></main></body></HTML>